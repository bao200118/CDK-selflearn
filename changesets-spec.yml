version: 0.2

phases:
  pre_build:
    commands:
      - yum install -y jq
      - echo "Fetching all parameters from SSM path /cdk-parameters/"
      # Fetch all parameters from SSM Parameter Store
      - PARAMETERS=$(aws ssm get-parameters-by-path --path "/cdk-parameters/" --recursive --with-decryption --query "Parameters" --output json)
      
      # Export each parameter as an environment variable
      - for row in $(echo "${PARAMETERS}" | jq -r '.[] | @base64'); do
            PARAM_NAME=$(echo ${row} | base64 --decode | jq -r '.Name' | sed 's|/cdk-parameters/||g' | tr '/' '_');
            PARAM_VALUE=$(echo ${row} | base64 --decode | jq -r '.Value');
            echo "Exporting $PARAM_NAME";
            export $PARAM_NAME="$PARAM_VALUE";
            echo "export $PARAM_NAME=\"$PARAM_VALUE\"" >> $CODEBUILD_SRC_DIR/.env;
        done

      - echo "All parameters have been exported successfully."

  build:
    commands:
      - npm install
      - echo "Configuring AWS CLI..."
      - aws --version  # Verify AWS CLI is installed
      - echo "Configuring AWS CDK..."
      - npm run cdk --version  # Verify AWS CDK is installed
      - echo "Retrieving AWS Account ID..."
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)  # Dynamically get Account ID
      - npm run cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION
      - npm run cdk-diff -- -c stage=stag
